name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate changelog
      id: changelog
      uses: actions/github-script@v7
      with:
        script: |
          const { data: commits } = await github.rest.repos.compareCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            base: 'main',
            head: context.sha
          });
          
          const changelog = commits.commits
            .map(commit => `- ${commit.commit.message}`)
            .join('\n');
          
          return changelog;
    
    - name: Create Release
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          const tagName = context.ref.replace('refs/tags/', '');
          const releaseName = `Release ${tagName}`;
          
          const releaseBody = `## üöÄ Hysteria2 VPN Client Release ${tagName}
          
          ### üì± Supported Platforms
          - **Android**: APK & AAB packages
          - **iOS**: Archive & Simulator builds
          - **Windows**: Native Windows application
          - **Linux**: Native Linux application
          - **macOS**: Native macOS application
          - **Web**: Progressive Web App
          - **Docker**: Multi-platform container
          
          ### üîß Build Information
          - **Commit**: ${context.sha}
          - **Branch**: ${context.ref_name}
          - **Build Date**: ${new Date().toISOString()}
          
          ### üìù Changelog
          ${${{ steps.changelog.outputs.result }}}
          
          ### üì¶ Downloads
          Build artifacts will be available once the CI/CD pipeline completes.
          
          ### üêõ Bug Reports
          If you encounter any issues, please report them on our [GitHub Issues](https://github.com/${context.repo.owner}/${context.repo.repo}/issues) page.
          
          ### üîó Links
          - [Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/README.md)
          - [Changelog](https://github.com/${context.repo.owner}/${context.repo.repo}/releases)
          - [Issues](https://github.com/${context.repo.owner}/${context.repo.repo}/issues)`;
          
          try {
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: releaseName,
              body: releaseBody,
              draft: false,
              prerelease: false
            });
            console.log(`Release ${tagName} created successfully!`);
          } catch (error) {
            console.error('Error creating release:', error);
            // Don't fail the workflow, just log the error
            console.log('Release creation failed, but continuing...');
          }
